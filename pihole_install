#!/bin/bash

# Verificar se é root
if [ "$(id -u)" -ne 0 ]; then
    echo "Este script deve ser executado como root. Use 'sudo -i' e execute novamente."
    exit 1
fi

# Atualizar o sistema
echo "Atualizando o sistema..."
apt update -y && apt upgrade -y

# Instalar dependências
echo "Instalando dependências..."
apt install -y curl wget git ufw

# Configurar firewall (UFW)
echo "Configurando firewall..."
ufw allow ssh
ufw allow 53/udp    # DNS Pi-hole
ufw allow 51820/udp # WireGuard
ufw --force enable

# Instalar Pi-hole (Automático)
echo "Instalando Pi-hole..."
curl -sSL https://install.pi-hole.net | bash

# Mensagem pós-instalação Pi-hole
echo "---------------------------------------------"
echo "Pi-hole instalado!"
echo "Senha da interface web:"
echo "Execute 'pihole -a -p' para definir uma senha."
echo "---------------------------------------------"

# Instalar WireGuard
echo "Instalando WireGuard..."
apt install -y wireguard resolvconf qrencode

# Gerar chaves WireGuard
echo "Gerando configurações do WireGuard..."
cd /etc/wireguard
umask 077
wg genkey | tee privatekey | wg pubkey > publickey

# Configurar WireGuard (substitua 'SEU_IP_VPS' pelo IP do seu VPS)
SERVER_IP=$(curl -4 ifconfig.co)
SERVER_PRIVKEY=$(cat privatekey)

cat > /etc/wireguard/wg0.conf <<EOF
[Interface]
Address = 10.8.0.1/24
ListenPort = 51820
PrivateKey = $SERVER_PRIVKEY
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE
SaveConfig = true
EOF

# Ativar NAT (para roteamento VPN)
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p

# Iniciar WireGuard
systemctl enable --now wg-quick@wg0

# Criar cliente WireGuard (dispositivo doméstico)
CLIENT_IP="10.8.0.2"
CLIENT_PRIVKEY=$(wg genkey)
CLIENT_PUBKEY=$(echo $CLIENT_PRIVKEY | wg pubkey)

cat > /etc/wireguard/client.conf <<EOF
[Interface]
PrivateKey = $CLIENT_PRIVKEY
Address = $CLIENT_IP/24
DNS = 10.8.0.1  # Usa o Pi-hole como DNS

[Peer]
PublicKey = $(cat publickey)
Endpoint = $SERVER_IP:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
EOF

# Adicionar cliente ao servidor WireGuard
wg set wg0 peer $CLIENT_PUBKEY allowed-ips $CLIENT_IP/32

# Gerar QR Code para conexão móvel
apt install -y qrencode
qrencode -t ansiutf8 < /etc/wireguard/client.conf

echo "---------------------------------------------"
echo "Configuração concluída!"
echo ""
echo "1. Pi-hole: Acesse http://$SERVER_IP/admin"
echo "2. WireGuard:"
echo "   - Copie o arquivo '/etc/wireguard/client.conf' para seu dispositivo."
echo "   - Ou use o QR Code acima para conectar um dispositivo móvel."
echo ""
echo "Recomendado: Altere a senha do Pi-hole com 'pihole -a -p'"
echo "---------------------------------------------"
